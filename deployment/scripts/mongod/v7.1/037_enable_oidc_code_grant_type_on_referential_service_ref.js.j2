{% if gateway.enabled | default(False) %}

db = db.getSiblingDB("cas");

print("START 037_enable_oidc_code_grant_type_on_referential_service_ref.js");

var serviceWithMaxId = db.services.aggregate([
    { $sort: { _id: -1 } },
    { $limit: 1 }
]).toArray();
var maxId = serviceWithMaxId.length > 0 ? serviceWithMaxId[0]._id : 0;

db.services.insertOne({
  _id: NumberInt(++maxId),
  _class: "org.apereo.cas.services.OidcRegisteredService",
  clientId: "{{ vitamui.referential.clientId | default('referential') }}",
  serviceId: "{{ vitamui.referential.serviceId | default('^' + vitamui.referential.base_url | default(url_prefix+'/referential') + '/.*') }}",
  name: "{{ vitamui.referential.name | default('Referential Application') }}",
  bypassApprovalPrompt: true,
  supportedGrantTypes: ["authorization_code"],
  supportedResponseTypes: ["code", "token"],
  attributeReleasePolicy: {
    _class: "org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy",
    allowedAttributes: ["authtoken"],
  },
  jsonFormat: true,
});

print("END 037_enable_oidc_code_grant_type_on_referential_service_ref.js");

{% endif %}
