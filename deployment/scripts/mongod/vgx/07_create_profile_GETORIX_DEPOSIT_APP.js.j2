db = db.getSiblingDB('iam')

print("START 07_create_profile_GETORIX_DEPOSIT_APP.js");

// ========================================= GETORIX_DEPOSIT : ADD NEW ADMIN PROFILE =========================================

var maxIdProfile = db.getCollection('sequences').findOne({'_id': 'profile_identifier'}).sequence;

db.tenants.find({ "identifier": { $gte: 0 } }).forEach(function (tenant) {

    db.profiles.insert({
        "_id" : "PROFIL_" + tenant.identifier + "-GETORIX_DEPOSIT_APP-ADMIN",
        "identifier" : NumberInt(maxIdProfile++),
        "name": "Getorix deposit Profile",
        "description": "Profil de l'application des versementgetorix",
        "tenantIdentifier": NumberInt(tenant.identifier),
        "applicationName" : "GETORIX_DEPOSIT_APP",
        "enabled" : true,
        "readonly" : true,
        "level" : "",
        "customerId" : tenant.customerId,
        "roles" : [
            {"name": "ROLE_GET_GETORIX_DEPOSIT"},
            {"name": "ROLE_CREATE_GETORIX_DEPOSIT"},
            {"name": "ROLE_UPDATE_GETORIX_DEPOSIT"},
            {"name": "ROLE_DELETE_GETORIX_DEPOSIT"}
         ]
    });

});


db.sequences.updateOne({
    "_id": "profile_identifier"
}, {
	$set: {
		"sequence": NumberInt(maxIdProfile)
	}
});


//============================ UPDATE ADMIN GROUPS =============================

var profileGetorixDepositId = "PROFIL_{{ vitamui_platform_informations.proof_tenant | default(1) }}-GETORIX_DEPOSIT_APP-ADMIN";

db.groups.updateOne({
    "_id": "5c79022e7884583d1ebb6e5d0bc0121822684250a3fd2996fd93c04634363363"
}, {
    $addToSet: {
        "profileIds": profileGetorixDepositId
    }
});

db.groups.updateOne({
    "_id": "admin_group"
}, {
    $addToSet: {
        "profileIds": profileGetorixDepositId
    }
});

print("END 07_create_profile_GETORIX_DEPOSIT_APP.js");
