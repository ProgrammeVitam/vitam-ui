---

- name: Compute list of mongo nodes
  set_fact:
    mongo_nodes: "{{ mongo_nodes | default([]) + [ hostvars[item]['ip_service'] + ':'+ mongodb.mongod_port | string ] }}"
  loop: "{{ groups['hosts_vitamui_mongod'] }}"
  when: hostvars[item]['mongo_arbiter'] | default(false) | bool == false

- name: Set Mongo URI and credentials
  set_fact:
    mongod_uri: "{{ mongo_nodes | join(',') }}"
    mongo_credentials: " -u {{ mongodb.admin.user }} -p {{ mongodb.admin.password }} --quiet"
  no_log: "{{ hide_passwords_during_deploy }}"

- name: 'Create temp folder'
  file:
    path: "{{ bootstrap_temp_dir }}"
    state: directory
  become: true

- name: "Compute scripts"
  template:
    src: "security.js.j2"
    dest: "{{ bootstrap_temp_dir }}/security.js"
  become: true

- name: 'List all mongo scripts'
  shell:
    cmd: 'find  {{ bootstrap_temp_dir }} -type f -iname "*.js"'
  register: files_matched
  become: true

- name: 'Execute scripts'
  shell: "mongosh mongodb://{{ mongod_uri }}/admin {{ mongo_credentials }} --file {{ item }}"
  no_log: "{{ hide_passwords_during_deploy }}"
  with_items: "{{ files_matched.stdout_lines }}"
  become: true

- name: 'Delete temp folder'
  file:
    path: "{{ bootstrap_temp_dir }}"
    state: absent
  become: true
