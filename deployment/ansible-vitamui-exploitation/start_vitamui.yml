---

########################################################
# START VITAMUI PLAYBOOK
########################################################

## COTS

### CONSUL
- hosts: hosts_vitamui
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: "{{ consul.service_name }}"
      port_service: "{{ consul.port | default(53) }}"
    ip_service: 127.0.0.1
    etat: started
  tags:
    - cots
    - consul

### LOGSTASH
- hosts: hosts_vitamui_logstash
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      vitamui_component: "{{ logstash.vitamui_component }}"
      port_service: "{{ logstash.port }}"
    etat: started
  tags:
    - cots
    - logstash

### MONGODB
- hosts: hosts_vitamui_mongod
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      vitamui_component: "{{ mongodb.vitamui_component }}"
      port_service: "{{ mongodb.mongod_port }}"
    etat: started
  tags:
    - cots
    - mongodb

- hosts: hosts_vitamui_mongod
  gather_facts: no
  roles:
    - { role: service_state, when: "mongo_express_enabled | default(false) | bool == true" }
    - check_port
  vars:
    vitamui_struct:
      vitamui_component: "{{ mongo_express.vitamui_component }}"
      port_service: "{{ mongo_express.port }}"
    etat: started
  tags:
    - cots
    - mongo_express

## VITAMUI COMPONENTS

### API GW
- hosts: hosts_vitamui_api_gateway
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.api_gateway }}"
    etat: started
  tags: api_gateway_app

### IAM
- hosts: hosts_vitamui_iam_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.iam_internal }}"
    etat: started
  tags: iam_app

- hosts: hosts_vitamui_security_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.security_internal }}"
    etat: started
  tags: security_app

- hosts: hosts_vitamui_iam_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.iam_external }}"
    etat: started
  tags: iam_app

### CAS
- hosts: hosts_cas_server
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.cas_server }}"
    etat: started
  tags: cas_server_app

### REFERENTIAL
- hosts: hosts_vitamui_referential_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.referential_internal }}"
    etat: started
  tags: referential_app

- hosts: hosts_vitamui_referential_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.referential_external }}"
    etat: started
  tags: referential_app

### INGEST
- hosts: hosts_vitamui_ingest_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.ingest_internal }}"
    etat: started
  tags: ingest_app

- hosts: hosts_vitamui_ingest_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.ingest_external }}"
    etat: started
  tags: ingest_app

### ARCHIVE SEARCH
- hosts: hosts_vitamui_archive_search_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.archive_search_internal }}"
    etat: started
  tags: archive_search_app

- hosts: hosts_vitamui_archive_search_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.archive_search_external }}"
    etat: started
  tags: archive_search_app

### PASTIS
- hosts: hosts_vitamui_pastis_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.pastis_external }}"
    etat: started
  tags: pastis_app

### COLLECT
- hosts: hosts_vitamui_collect_internal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.collect_internal }}"
    etat: started
  tags: collect_app

- hosts: hosts_vitamui_collect_external
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct: "{{ vitamui.collect_external }}"
    etat: started
  tags: collect_app

### FRONTEND APPS
- hosts: hosts_ui_referential
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.referential.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_ingest
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.ingest.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_archive_search
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.archive_search.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_pastis
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.pastis.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_collect
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.collect.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_identity_admin
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.identity_admin.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_identity
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.identity.port_service }}"
    etat: started
  tags: frontend_apps

- hosts: hosts_ui_portal
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: "{{ vitamui.portal.port_service }}"
    etat: started
  tags: frontend_apps

### REVERSE
- hosts: hosts_vitamui_reverseproxy
  gather_facts: no
  roles:
    - service_state
    - check_port
  vars:
    vitamui_struct:
      service_name: nginx
      port_service: 443
    etat: started
  tags: reverseproxy
