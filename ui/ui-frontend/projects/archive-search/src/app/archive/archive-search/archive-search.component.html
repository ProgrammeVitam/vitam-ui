<div class="archive-search-section">
  <div class="row">
    <h5>{{ 'ARCHIVE_SEARCH.TITLE_SEARCH' | translate }}</h5>
  </div>

  <div class="row justify-content-around">
    <div class="col-8 form-control">
      <title-and-description-criteria-search></title-and-description-criteria-search>
    </div>
    <div class="col-1 form-control"></div>
    <div class="col-3 form-control text-right">
      <button type="button" class="btn primary" [disabled]="searchCriteriaKeys.length === 0" (click)="submit()">
        {{ 'ARCHIVE_SEARCH.LAUNCH_SEARCH_ACTION' | translate }}
      </button>
    </div>
  </div>
  <div class="row justify-content-around">
    <div class="col-11">
      <div class="area-criteria">
        <ng-container *ngFor="let criteriaKey of searchCriteriaKeys">
          <ng-container *ngIf="searchCriterias.get(criteriaKey) as criteriaVal">
            <app-criteria-search
              [criteriaKey]="criteriaKey"
              [criteriaVal]="criteriaVal"
              (criteriaRemoveEvent)="removeCriteriaEvent($event)"
            ></app-criteria-search>
          </ng-container>
        </ng-container>
      </div>
    </div>
    <div class="col-1">
      <div class="d-flex justify-content-end button-space">
        <button [matMenuTriggerFor]="menu" class="mat-boutton">
          <button type="button" class="circle editable-field-cancel clickable">
            <i class="material-icons primary-save-icon">save</i>
          </button>
        </button>

        <mat-menu #menu="matMenu" class="my-menu">
          <button
            mat-menu-item
            [disabled]="!searchCriterias || searchCriterias.size <= 0"
            (click)="mapSearchCriteriaHistory()"
            class="btn-new-save"
          >
            <i class="material-icons btn-add">add</i>
            {{ 'ARCHIVE_SEARCH.SEARCH_CRITERIA_SAVER.NEW_SAVE_MENU' | translate }}
          </button>
          <app-search-criteria-list (storedSearchCriteriaHistory)="showStoredSearchCriteria($event)"> </app-search-criteria-list>
        </mat-menu>
        <div *ngIf="searchCriterias && searchCriterias.size > 0" class="d-flex justify-content-end div-btn-delete">
          <button class="mat-boutton">
            <button type="button" class="circle editable-field-cancel clickable" (click)="clearCriterias()">
              <i class="material-icons primary-save-icon">delete</i>
            </button>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row" *ngIf="!showCriteriaPanel">
    <a class="hide-ink" (click)="showHidePanel(true)">{{ 'ARCHIVE_SEARCH.SHOW_SEARCH_CRITERIA' | translate }}</a>
  </div>

  <div [hidden]="!showCriteriaPanel">
    <mat-tab-group [selectedIndex]="additionalSearchCriteriaCategoryIndex" (selectedIndexChange)="selectedCategoryChange($event)">
      <mat-tab label="{{ 'ARCHIVE_SEARCH.SEARCH_CRITERIA_FILTER.TITLE' | translate }}">
        <div class="card-criteria">
          <simple-criteria-search></simple-criteria-search>
        </div>
      </mat-tab>
      <mat-tab *ngFor="let category of additionalSearchCriteriaCategories; let index = index">
        <ng-template mat-tab-label>
          <span> {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.' + category.name | translate }} </span>
          <button class="mat-boutton clickable" (click)="removeCriteriaCategory(category.name)">
            <i class="vitamui-icon vitamui-icon-cross vitamui-row-icon"></i>
          </button>
        </ng-template>
        <ng-container
          *vitamuiCommonHasRole="{
            appId: 'ARCHIVE_SEARCH_MANAGEMENT_APP',
            tenantIdentifier: +this.tenantIdentifier,
            role: 'ROLE_SEARCH_WITH_RULES'
          }"
        >
          <div class="card-criteria" *ngIf="category.name === 'APPRAISAL_RULE'">
            <div class="row justify-content-end text-on-right-side">
              <a class="hide-ink" (click)="removeCriteriaByCategory('APPRAISAL_RULE')">{{
                'ARCHIVE_SEARCH.REMOVE_SEARCH_CRITERIA_BY_CATEGORY' | translate
              }}</a>
            </div>
            <appraisal-rule-search></appraisal-rule-search>
          </div>
        </ng-container>
      </mat-tab>

      <mat-tab disabled>
        <ng-template mat-tab-label>
          <button [matMenuTriggerFor]="menuTabs" class="mat-boutton clickable">
            {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.ADD' | translate }}
            <i class="vitamui-icon vitamui-icon-plus vitamui-row-icon"></i>
          </button>
        </ng-template>
      </mat-tab>

      <mat-menu #menuTabs="matMenu" class="my-menu">
        <button
          *vitamuiCommonHasRole="{
            appId: 'ARCHIVE_SEARCH_MANAGEMENT_APP',
            tenantIdentifier: +this.tenantIdentifier,
            role: 'ROLE_SEARCH_WITH_RULES'
          }"
          mat-menu-item
          class="btn-new-save"
          (click)="addCriteriaCategory('APPRAISAL_RULE')"
          [disabled]="isCategoryAdded('APPRAISAL_RULE')"
        >
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.APPRAISAL_RULE' | translate }}
        </button>
        <button mat-menu-item class="btn-new-save" (click)="addCriteriaCategory('DUC')" [disabled]="isCategoryAdded('DUC')">
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.DUC' | translate }}
        </button>
        <button
          mat-menu-item
          class="btn-new-save"
          (click)="addCriteriaCategory('COMMUNICABILITY')"
          [disabled]="isCategoryAdded('COMMUNICABILITY')"
        >
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.COMMUNICABILITY' | translate }}
        </button>
        <button mat-menu-item class="btn-new-save" (click)="addCriteriaCategory('REUSING')" [disabled]="isCategoryAdded('REUSING')">
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.REUSING' | translate }}
        </button>
        <button mat-menu-item class="btn-new-save" (click)="addCriteriaCategory('DIFFUSION')" [disabled]="isCategoryAdded('DIFFUSION')">
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.DIFFUSION' | translate }}
        </button>
        <button
          mat-menu-item
          class="btn-new-save"
          (click)="addCriteriaCategory('CLASSIFICATION')"
          [disabled]="isCategoryAdded('CLASSIFICATION')"
        >
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.CLASSIFICATION' | translate }}
        </button>
        <button mat-menu-item class="btn-new-save" (click)="addCriteriaCategory('GEL')" [disabled]="isCategoryAdded('GEL')">
          {{ 'ARCHIVE_SEARCH.CRITERIA_CATEGORY.GEL' | translate }}
        </button>
      </mat-menu>
    </mat-tab-group>
  </div>
  <div class="row justify-content-end text-on-right-side" *ngIf="showCriteriaPanel">
    <a class="hide-ink" (click)="showHidePanel(false)">{{ 'ARCHIVE_SEARCH.HIDE_SEARCH_CRITERIA' | translate }}</a>
  </div>
</div>

<div vitamuiCommonInfiniteScroll (vitamuiScroll)="loadMore()" *ngIf="submited">
  <div class="vitamui-table">
    <div class="vitamui-table-head">
      <div class="col-8" *ngIf="totalResults > 1 || totalResults === 0">
        {{ totalResults }} {{ 'ARCHIVE_SEARCH.RESULTS' | translate }} / {{ itemSelected }} {{ 'ARCHIVE_SEARCH.DIP.SELECTED' | translate }}
      </div>
      <div class="col-8" *ngIf="totalResults === 1">
        {{ totalResults }} {{ 'ARCHIVE_SEARCH.RESULT' | translate }} / {{ itemSelected }}
        {{ 'ARCHIVE_SEARCH.DIP.ONE_SELECTED' | translate }}
      </div>
      <div class="col-3 area-download">
        <i
          (click)="exportArchiveUnitsToCsvFile()"
          *ngIf="totalResults > 0"
          class="vitamui-icon vitamui-icon-download-basic vitamui-row-icon icon-download clickable"
        ></i>
      </div>
      <div class="col-1">
        <vitamui-common-menu-button [overlayPos]="'end'" [icon]="'vitamui-icon-more-horiz'">
          <button
            mat-menu-item
            (click)="openExportDIPRequestCreateDialog()"
            [disabled]="(itemSelected === 0 && hasDipExportRole) || !hasDipExportRole"
          >
            {{ 'ARCHIVE_SEARCH.DIP.EXPORT_DIP' | translate }}
          </button>
        </vitamui-common-menu-button>
      </div>
    </div>

    <div class="vitamui-table-head">
      <div class="col-1 d-flex align-items-center">
        <input
          class="criteria-choice-input"
          type="checkbox"
          [checked]="isAllchecked"
          [indeterminate]="isIndeterminate"
          (change)="checkParentBoxChange($event)"
        />
      </div>
      <div class="col-1 d-flex align-items-center">
        <button
          class="vitamui-filter-button"
          [vitamuiCommonTableFilter]="typeFilterTemplate"
          [class.active]="filterMapType['Type'] && filterMapType['Type'].length > 0"
        >
          <i class="material-icons vitamui-row-icon">filter_list</i>
        </button>

        <ng-template #typeFilterTemplate>
          <vitamui-common-table-filter [(filter)]="filterMapType['Type']" (filterChange)="onFilterChange('Type', $event)">
            <vitamui-common-table-filter-option value="Document">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-file vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.DOCUMENT' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Folder">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.FOLDER' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Subgrp">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.SUBGRP' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Subseries">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.SUBSERIES' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Series">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.SERIES' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Collection">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.COLLECTION' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Class">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.CLASS' | translate }}
              </div>
            </vitamui-common-table-filter-option>

            <vitamui-common-table-filter-option value="Subfonds">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.SUBFONDS' | translate }}
              </div>
            </vitamui-common-table-filter-option>

            <vitamui-common-table-filter-option value="Fonds">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.FONDS' | translate }}
              </div>
            </vitamui-common-table-filter-option>
            <vitamui-common-table-filter-option value="Otherlevel">
              <div class="table-filter-icon">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
                {{ 'ARCHIVE_SEARCH.OTHERLEVEL' | translate }}
              </div>
            </vitamui-common-table-filter-option>
          </vitamui-common-table-filter>
        </ng-template>

        <vitamui-common-order-by-button
          orderByKey="DescriptionLevel"
          [(orderBy)]="orderBy"
          [(direction)]="direction"
          (orderChange)="emitOrderChange()"
        ></vitamui-common-order-by-button>
      </div>

      <div class="col-4 d-flex align-items-center">
        <span
          >{{ 'ARCHIVE_SEARCH.ARCHIVE_UNIT.FIELDS.NAME' | translate }} <br />{{
            'ARCHIVE_SEARCH.ARCHIVE_UNIT.FIELDS.DESCRIPTION' | translate
          }}</span
        >

        <vitamui-common-order-by-button
          orderByKey="Title"
          [(orderBy)]="orderBy"
          [(direction)]="direction"
          (orderChange)="emitOrderChange()"
        ></vitamui-common-order-by-button>
      </div>

      <div class="col-2 d-flex align-items-center">
        <span>{{ 'ARCHIVE_SEARCH.ARCHIVE_UNIT.FIELDS.START_DATE' | translate }} </span>
        <vitamui-common-order-by-button
          orderByKey="StartDate"
          [(orderBy)]="orderBy"
          [(direction)]="direction"
          (orderChange)="emitOrderChange()"
        ></vitamui-common-order-by-button>
      </div>

      <div class="col-2 d-flex align-items-center">
        <span>{{ 'ARCHIVE_SEARCH.ARCHIVE_UNIT.FIELDS.END_DATE' | translate }} </span>
        <vitamui-common-order-by-button
          orderByKey="EndDate"
          [(orderBy)]="orderBy"
          [(direction)]="direction"
          (orderChange)="emitOrderChange()"
        ></vitamui-common-order-by-button>
      </div>

      <div class="col-2 d-flex align-items-center">
        <span>{{ 'ARCHIVE_SEARCH.ARCHIVE_UNIT.FIELDS.SP' | translate }}</span>
        <vitamui-common-order-by-button
          orderByKey="#originating_agencies"
          [(orderBy)]="orderBy"
          [(direction)]="direction"
          (orderChange)="emitOrderChange()"
        ></vitamui-common-order-by-button>
      </div>
    </div>

    <div class="vitamui-table-body">
      <div class="vitamui-table-rows" *ngFor="let archiveUnit of archiveUnits; let index = index">
        <div class="vitamui-row d-flex align-items-center">
          <div class="col-1 d-flex align-items-center">
            <input
              class="criteria-choice-input"
              type="checkbox"
              (click)="checkChildrenBoxChange(archiveUnit['#id'], $event)"
              [checked]="isAllchecked"
            />
          </div>
          <div class="col-1 d-flex align-items-center clickable" (click)="archiveUnitClick.emit(archiveUnit)">
            <span class="table-filter-icon" [ngSwitch]="archiveUnit?.DescriptionLevel">
              <ng-container *ngSwitchCase="'RecordGrp'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *ngSwitchCase="'File'">
                <i class="vitamui-icon vitamui-icon-file vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *ngSwitchCase="'Item'">
                <i class="vitamui-icon vitamui-icon-file vitamui-row-icon status-badge"></i> </ng-container
              ><ng-container *ngSwitchCase="'Collection'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *ngSwitchCase="'Subfonds'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *ngSwitchCase="'Class'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *ngSwitchCase="'Subgrp'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i> </ng-container
              ><ng-container *ngSwitchCase="'Otherlevel'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i> </ng-container
              ><ng-container *ngSwitchCase="'Series'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i> </ng-container
              ><ng-container *ngSwitchCase="'Subseries'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i> </ng-container
              ><ng-container *ngSwitchCase="'Fonds'">
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
              <ng-container *NgSwitchDefault>
                <i class="vitamui-icon vitamui-icon-folder vitamui-row-icon status-badge"></i>
              </ng-container>
            </span>
          </div>
          <div class="col-4 d-flex align-items-center clickable" (click)="archiveUnitClick.emit(archiveUnit)">
            <ng-container *ngIf="archiveUnit?.Title; else subTitleFr">
              <p matTooltip="{{ archiveUnit?.Description }}" matTooltipClass="vitamui-tooltip" [matTooltipShowDelay]="300">
                <b> {{ archiveUnit?.Title }}</b> <br />
                {{ archiveUnit?.Description | truncate: 100 }}
              </p>
            </ng-container>
            <ng-template #subTitleFr>
              <ng-container *ngIf="archiveUnit.Title_.fr; else subTitleEn">
                <p matTooltip="{{ archiveUnit?.Description }}" matTooltipClass="vitamui-tooltip" [matTooltipShowDelay]="300">
                  <b>{{ archiveUnit.Title_.fr }} </b> <br />
                  {{ archiveUnit?.Description | truncate: 100 }}
                </p>
              </ng-container>
            </ng-template>
            <ng-template #subTitleEn>
              <ng-container *ngIf="archiveUnit.Title_.en">
                <p matTooltip="{{ archiveUnit?.Description }}" matTooltipClass="vitamui-tooltip" [matTooltipShowDelay]="300">
                  <b>{{ archiveUnit.Title_.en }} </b> <br />
                  {{ archiveUnit?.Description | truncate: 100 }}
                </p>
              </ng-container>
            </ng-template>
          </div>
          <div class="col-2 d-flex align-items-center clickable" (click)="archiveUnitClick.emit(archiveUnit)">
            {{ archiveUnit?.StartDate | date: 'dd/MM/yyyy' }}
          </div>
          <div class="col-2 d-flex align-items-center clickable" (click)="archiveUnitClick.emit(archiveUnit)">
            {{ archiveUnit?.EndDate | date: 'dd/MM/yyyy' }}
          </div>
          <div class="col-2 d-flex align-items-center clickable" (click)="archiveUnitClick.emit(archiveUnit)">
            <p
              matTooltip="{{ archiveUnit['originating_agencyName'] }}   ({{ archiveUnit['#originating_agencies'] }})"
              matTooltipClass="vitamui-tooltip"
              [matTooltipShowDelay]="300"
            >
              {{ archiveUnit['originating_agencyName'] }}
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="vitamui-table-footer">
      <mat-spinner *ngIf="pending" diameter="50" color="accent"></mat-spinner>
      <button *ngIf="!pending && canLoadMore" (click)="loadMore()" class="btn">
        {{ 'ARCHIVE_SEARCH.SHOW_MORE_RESULTS' | translate }}
      </button>
      <span *ngIf="!pending && !canLoadMore">{{ 'ARCHIVE_SEARCH.NO_MORE_RESULTS' | translate }}</span>
    </div>
  </div>
</div>
